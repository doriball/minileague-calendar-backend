<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>매장 관리</title>
</head>
<body>

<div layout:fragment="content">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">매장 관리</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal"
                    data-bs-target="#storeCreateModal">
                <i class="bi bi-plus-lg"></i> 신규 등록
            </button>
        </div>
    </div>

    <!-- 필터 및 검색 영역 -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <form th:action="@{/stores}" method="get" class="row g-3 align-items-center">
                <!-- 지역 필터 -->
                <div class="col-auto">
                    <select name="regionNo" class="form-select form-select-sm">
                        <option value="">전체 지역</option>
                        <option th:each="region : ${storeRegions}"
                                th:value="${region.regionNo}"
                                th:text="${region.name}"
                                th:selected="${command != null and command.regionNo == region.regionNo}">
                        </option>
                    </select>
                </div>

                <!-- 검색바 (드롭다운 제외) -->
                <div class="col-auto ms-auto">
                    <div class="input-group input-group-sm">
                        <input type="text" name="keyword" class="form-control" placeholder="매장명 검색"
                               th:value="${command?.keyword}">
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 매장 목록 테이블 -->
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th style="width: 10%">지역</th>
                <th style="width: 25%">매장명</th>
                <th>주소</th>
                <th style="width: 15%">등록일</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${#lists.isEmpty(stores)}">
                <td colspan="4" class="text-center py-4 text-muted">조회된 매장이 없습니다.</td>
            </tr>
            <tr th:each="store : ${stores}">
                <td th:text="${store.region}">서울</td>
                <td>
                    <a href="javascript:void(0)" class="text-decoration-none fw-bold text-dark"
                       th:data-id="${store.id}"
                       onclick="showStoreDetail(this.getAttribute('data-id'))"
                       th:text="${store.name}">매장명</a>
                </td>
                <td th:text="${store.address}">주소 정보</td>
                <td th:text="${#temporals.format(store.createdAt, 'yyyy-MM-dd')}">2023-01-01</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 모달 삽입 -->
    <div th:replace="~{store/store_detail_modal :: modal}"></div>
    <div th:replace="~{store/store_create_modal :: modal}"></div>
    <div th:replace="~{store/store_edit_modal :: modal}"></div>

    <script th:inline="javascript">
        let detailModal, createModal, editModal;

        document.addEventListener('DOMContentLoaded', function () {
            detailModal = new bootstrap.Modal(document.getElementById('storeDetailModal'));
            createModal = new bootstrap.Modal(document.getElementById('storeCreateModal'));
            editModal = new bootstrap.Modal(document.getElementById('storeEditModal'));

            // 수정 취소 시 상세 모달로 복귀
            document.getElementById('btnCancelStoreEdit').addEventListener('click', function () {
                const id = document.getElementById('editStoreId').value;
                editModal.hide();
                showStoreDetail(id);
            });
        });

        function showStoreDetail(id) {
            document.getElementById('ruleStoreId').value = id; // 현재 매장 ID 저장
            toggleRuleForm(false); // 폼 초기화

            const getDetail = axios.get('/api/v1/stores/' + id);
            const getRules = axios.get('/api/v1/stores/' + id + '/rules');

            Promise.all([getDetail, getRules])
                .then(function (results) {
                    const store = results[0].data.data;
                    const rules = results[1].data.data;

                    document.getElementById('modalStoreName').innerText = store.name;
                    document.getElementById('modalStoreRegion').innerText = store.region;
                    document.getElementById('modalStoreAddress').innerText = store.address;
                    document.getElementById('modalStoreMap').innerText = store.map || '-';
                    document.getElementById('modalStoreSns').innerText = store.sns || '-';

                    // 일정 목록 렌더링 로직을 별도 함수로 호출하거나 동일하게 수정
                    innerRenderRules(id, rules);

                    document.getElementById('btnDeleteStore').onclick = () => deleteStore(id);
                    document.getElementById('btnEditStore').onclick = () => openEditModal(id);

                    detailModal.show();
                })
                .catch(err => alert('정보를 불러오는 중 오류가 발생했습니다.'));
        }

        // 중복 로직 방지를 위한 내부 렌더링 함수
        function innerRenderRules(storeId, rules) {
            const tableBody = document.getElementById('ruleTableBody');
            tableBody.innerHTML = '';

            if (!rules || rules.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">등록된 정기 일정이 없습니다.</td></tr>';
                return;
            }

            rules.forEach(rule => {
                let displayTime = rule.scheduledAt;
                if (Array.isArray(rule.scheduledAt)) {
                    displayTime = String(rule.scheduledAt[0]).padStart(2, '0') + ':' + String(rule.scheduledAt[1]).padStart(2, '0');
                } else if (typeof displayTime === 'string') {
                    displayTime = displayTime.substring(0, 5);
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="badge bg-light text-dark border">${rule.dayOfWeek}</span></td>
                    <td>${displayTime}</td>
                    <td class="fw-bold">${rule.name} ${rule.official ? '<span class="badge bg-primary ms-1">공인</span>' : ''}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-2 me-1 btn-rule-edit">수정</button>
                        <button type="button" class="btn btn-sm btn-outline-danger py-0 px-2 btn-rule-delete">삭제</button>
                    </td>
                `;

                // 데이터 객체를 직접 클로저로 전달하여 따옴표 문제 완전 차단
                tr.querySelector('.btn-rule-edit').onclick = () => editRule(rule);
                tr.querySelector('.btn-rule-delete').onclick = () => deleteRule(storeId, rule.id);

                tableBody.appendChild(tr);
            });
        }

        function openEditModal(id) {
            // 현재 매장 정보 불러와서 폼에 채우기
            axios.get('/api/v1/stores/' + id).then(res => {
                const data = res.data.data;
                document.getElementById('editStoreId').value = id;
                document.getElementById('editStoreName').value = data.name;
                document.getElementById('editStoreAddress').value = data.address;
                document.getElementById('editStoreMap').value = data.map || '';
                document.getElementById('editStoreSns').value = data.sns || '';

                // 지역 select (이름 매칭 혹은 추가 API 연동 필요할 수 있으나 현재 구조상 DTO에 regionNo가 없으므로 name으로 매칭 시도 혹은 regionNo 추가 필요)
                const regionSelect = document.getElementById('editStoreRegionNo');
                for (let i = 0; i < regionSelect.options.length; i++) {
                    if (regionSelect.options[i].text === data.region) {
                        regionSelect.selectedIndex = i;
                        break;
                    }
                }

                detailModal.hide();
                editModal.show();
            });
        }

        function submitStoreCreate() {
            const form = document.getElementById('storeCreateForm');
            const data = {
                name: form.name.value,
                regionNo: parseInt(form.regionNo.value),
                address: form.address.value,
                map: form.map.value,
                sns: form.sns.value
            };

            axios.post('/api/v1/stores', data)
                .then(() => {
                    alert('등록되었습니다.');
                    location.reload();
                })
                .catch(err => alert(err.response?.data?.message || '등록 중 오류 발생'));
        }

        function submitStoreEdit() {
            const id = document.getElementById('editStoreId').value;
            const form = document.getElementById('storeEditForm');
            const data = {
                name: form.name.value,
                regionNo: parseInt(form.regionNo.value),
                address: form.address.value,
                map: form.map.value,
                sns: form.sns.value
            };

            axios.post('/api/v1/stores/' + id, data) // UpdateStore API가 POST $BASE_PATH/{id} 로 되어있음
                .then(() => {
                    alert('수정되었습니다.');
                    editModal.hide();
                    showStoreDetail(id);
                })
                .catch(err => alert(err.response?.data?.message || '수정 중 오류 발생'));
        }

        function deleteStore(id) {
            if (!confirm('정말 삭제하시겠습니까?')) return;
            axios.delete('/api/v1/stores/' + id)
                .then(() => {
                    alert('삭제되었습니다.');
                    location.reload();
                })
                .catch(err => alert(err.response?.data?.message || '삭제 실패'));
        }

        function renderRules(id) {
            axios.get('/api/v1/stores/' + id + '/rules')
                .then(res => innerRenderRules(id, res.data.data))
                .catch(err => console.error(err));
        }

        function toggleRuleForm(show) {
            const container = document.getElementById('ruleFormContainer');
            const form = document.getElementById('ruleForm');
            if (show === undefined) show = container.classList.contains('d-none');

            if (show) {
                container.classList.remove('d-none');
                if (document.getElementById('stageListContainer').children.length === 0) {
                    addStageRow(); // 열릴 때 기본 1개 추가
                }
            } else {
                container.classList.add('d-none');
                form.reset();
                document.getElementById('ruleId').value = '';
                document.getElementById('stageListContainer').innerHTML = ''; // 스테이지 초기화
            }
        }

        function addStageRow(data) {
            const container = document.getElementById('stageListContainer');
            const index = container.children.length;
            const stageDiv = document.createElement('div');
            stageDiv.className = 'row g-2 mb-2 stage-row border-bottom pb-2';
            stageDiv.innerHTML = `
                <div class="col-md-4">
                    <select class="form-select form-select-sm stage-type" required>
                        <option value="SWISS" ${data?.type === 'SWISS' ? 'selected' : ''}>스위스 라운드</option>
                        <option value="TOURNAMENT" ${data?.type === 'TOURNAMENT' ? 'selected' : ''}>토너먼트</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">R</span>
                        <input type="number" class="form-control stage-round" value="${data?.roundCount || 3}" min="1" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">G</span>
                        <input type="number" class="form-control stage-game" value="${data?.gameCount || 1}" min="1" required>
                    </div>
                </div>
                <div class="col-md-2 text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger border-0" onclick="this.closest('.stage-row').remove()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(stageDiv);
        }

        function editRule(rule) {
            toggleRuleForm(true);
            document.getElementById('ruleId').value = rule.id;
            document.getElementById('ruleName').value = rule.name;
            document.getElementById('ruleDayOfWeek').value = rule.dayOfWeek;
            document.getElementById('ruleScheduledAt').value = rule.scheduledAt;
            document.getElementById('ruleOfficial').checked = rule.official;

            // 기존 스테이지 렌더링
            const container = document.getElementById('stageListContainer');
            container.innerHTML = '';
            if (rule.stages && rule.stages.length > 0) {
                rule.stages.forEach(stage => addStageRow(stage));
            } else {
                addStageRow();
            }
        }

        function submitRule() {
            const storeId = document.getElementById('ruleStoreId').value;
            const ruleId = document.getElementById('ruleId').value;

            // 스테이지 목록 수집
            const stageRows = document.querySelectorAll('.stage-row');
            if (stageRows.length === 0) {
                alert('최소 1개의 스테이지 설정이 필요합니다.');
                return;
            }

            const stages = Array.from(stageRows).map((row, idx) => ({
                stageNo: idx + 1,
                type: row.querySelector('.stage-type').value,
                roundCount: parseInt(row.querySelector('.stage-round').value),
                gameCount: parseInt(row.querySelector('.stage-game').value)
            }));

            // 시간 값 처리: HH:mm 형식일 경우에만 :00을 붙여 LocalTime 형식을 맞춤
            let scheduledAtValue = document.getElementById('ruleScheduledAt').value;
            if (scheduledAtValue && scheduledAtValue.length === 5) {
                scheduledAtValue += ":00";
            }

            const data = {
                name: document.getElementById('ruleName').value,
                dayOfWeek: document.getElementById('ruleDayOfWeek').value,
                scheduledAt: scheduledAtValue,
                official: document.getElementById('ruleOfficial').checked,
                stages: stages
            };

            const promise = ruleId
                ? axios.put(`/api/v1/stores/${storeId}/rules/${ruleId}`, data)
                : axios.post(`/api/v1/stores/${storeId}/rules`, data);

            promise.then(() => {
                alert('저장되었습니다.');
                toggleRuleForm(false);
                renderRules(storeId);
            }).catch(err => alert(err.response?.data?.message || '일정 저장 중 오류가 발생했습니다.'));
        }

        function deleteRule(storeId, ruleId) {
            if (!confirm('해당 미니리그 일정을 정말 삭제하시겠습니까?')) {
                return;
            }

            axios.delete(`/api/v1/stores/${storeId}/rules/${ruleId}`)
                .then(function (response) {
                    alert('일정이 삭제되었습니다.');
                    renderRules(storeId); // 목록 갱신
                })
                .catch(function (error) {
                    console.error('Error deleting rule:', error);
                    const message = error.response?.data?.message || '일정 삭제 중 오류가 발생했습니다.';
                    alert(message);
                });
        }
    </script>

    <!-- 페이지네이션 -->
    <nav th:if="${not #lists.isEmpty(paginationBars)}" aria-label="Page navigation" class="mt-4">
        <ul class="pagination pagination-sm justify-content-center">
            <li class="page-item" th:classappend="${(command?.page ?: 1) == 1} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/stores(page=${(command?.page ?: 1) - 1}, regionNo=${command?.regionNo}, keyword=${command?.keyword})}">이전</a>
            </li>
            <li class="page-item" th:each="bar : ${paginationBars}"
                th:classappend="${bar + 1 == (command?.page ?: 1)} ? 'active'">
                <a class="page-link" th:text="${bar + 1}"
                   th:href="@{/stores(page=${bar + 1}, regionNo=${command?.regionNo}, keyword=${command?.keyword})}">1</a>
            </li>
            <li class="page-item"
                th:classappend="${not #lists.isEmpty(paginationBars) and (command?.page ?: 1) > paginationBars.get(paginationBars.size() - 1)} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/stores(page=${(command?.page ?: 1) + 1}, regionNo=${command?.regionNo}, keyword=${command?.keyword})}">다음</a>
            </li>
        </ul>
    </nav>
</div>

</body>
</html>